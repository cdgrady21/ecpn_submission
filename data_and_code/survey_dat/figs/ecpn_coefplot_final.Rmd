---
title: "ecpn_coefplot"
author: "cdgrady21"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)

load('ag.coefs.Rdata')
load('ind.coefs.Rdata')

#load('ind2.coefs.Rdata')
#load('ag.coefs_orig.Rdata')
#load('ind.coefs_orig.Rdata')
#load('ind2.coefs_orig.Rdata')

## add obs data to coefs
#load("../../obsDat/figs/marketCoefs1.rda") # no FEs, should be unbiased
#load("../../obsDat/figs/eventCoefs1.rda") # no FEs
load("../../obs_dat/figs/obsDat_fig_dat.rda")


```
```{r, eval=F}
# OLD adding non-bootstrap obs data
load("../../obsDat/analysis/marketMedian.Rdata")
load("../../obsDat/analysis/eventsMedian.Rdata")

marks <- as.data.frame(markMed.thing[c("pastoralists_index", "farmers_index"),])
marks$sd <- NA
marks["pastoralists_index","sd"] <- sd(markets$pastoralists_index, na.rm=T)
marks["farmers_index","sd"] <- sd(markets$farmers_index, na.rm=T)

evs <- as.data.frame(eventsMed.thing[c("attend_total", "eat_total"),])
evs$sd <- NA
evs["attend_total","sd"] <- sd(events$attend_total, na.rm=T)
evs["eat_total","sd"] <- sd(events$eat_total, na.rm=T)

markEvs <- rbind(marks,evs)
markEvs[,c("ll", "ul")] <- markEvs[,c("lower", "upper")]; markEvs[,c("lower", "upper")] <- NULL
addNames <- setdiff(names(ag.coefs), names(markEvs))
markEvs[,addNames] <- NA
markEvs$var <- rownames(markEvs)
markEvs$size <- markEvs$coef/markEvs$sd
markEvs[,c("ll_size", "ul_size")] <- markEvs[,c("ll", "ul")]/markEvs$sd
markEvs <- markEvs[c(names(ag.coefs))]

ag.coefs <- rbind(ag.coefs, markEvs)

```

# Coefplots

1. Aggregate Survey outcomes
2. Aggregate + observational outcomes
3. Individual-level survey outcomes

Survey Outcomes: 
  - voluntary intergroup contact ()
  - feelings of physical security
  - intergroup attitudes

***************

2. Aggregate + observational outcomes

Order: Contact, Perceptions Security, Attitudes, PGG.

```{r}
outcome <- ag.coefs
outcome <- outcome[grepl("Trust|contact|in_cw|end_exp|rMean|pgp", outcome$var),]
outcome <- outcome[,c("var", "size", "ll_size", "ul_size")]
names(outcome) <- c("var", "coef_sd", "ll_sd", "ul_sd")
outcome$var <- c("Self-reported Attitudes", "Self-reported Contact", 
                 "Perceptions of Insecurity",
                 "Public Goods Amount", "Public Goods Donation",
                 "Contact Willingness", "Endorsement Experiment")
outcome$outcome_type <- c("atts", "con", "in","pgg", "pgg", "con", "atts")

outcome2$outcome_type <- "con"
outcome2$Data <- "Behavior"
outcome2$var <- c("Pastoralists in Market",
                  "Farmers in Market",
                  "Outgroup Event Attendance")
outcome2$df <- NULL
outcome$Data <- "Survey"
outcome$Data[outcome$outcome_type %in% "pgg"] <- "Behavior"
svyObs_outcomes <- rbind(outcome, outcome2)
svyObs_outcomes$hypothesis <- c("Attitudes", "Contact", "Insecurity", 
                                "Cooperation", "Cooperation", "Contact",
                                "Attitudes", 
                                "Contact", "Contact", "Contact")
res <- svyObs_outcomes
res$hypothesisF <-
  factor(res$hypothesis,
         levels = c("Contact", "Insecurity", "Attitudes", "Cooperation"))
res$varF <-
  factor(res$var,
         levels = c("Self-reported Contact", "Contact Willingness",
                    "Pastoralists in Market",
                    "Farmers in Market", "Outgroup Event Attendance",
                    "Self-reported Attitudes", "Perceptions of Insecurity",
                    "Public Goods Amount", "Public Goods Donation", "Endorsement Experiment"))

ggplot(data = res, aes(x = varF, y = coef_sd, color = Data)) +
  facet_grid(vars(hypothesisF), scales="free", space = "free")+
  geom_point()+
  geom_errorbar(aes(ymin = ll_sd, ymax = ul_sd, color = Data), width = 0) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray")+
  labs(y = "Effect Size & 95% CI", x = NULL)+
  theme_bw() +
  #theme(axis.text = element_text(size = 12))+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggsave("coef1.png", height=6)


```
```{r, eval=F}
svy_coefplot <- ggplot(outcome, aes(y=coef_sd, x = var)) +
  geom_hline(aes(yintercept = 0), linetype="dashed", color="gray")+
  geom_point(aes(shape=outcome_type, size=4)) +
  #scale_shape_manual(values=c("atts"=19, "con"=18, "in"=17))+
  geom_errorbar(aes(ymin=ll_sd, ymax=ul_sd, width=0)) +
  #scale_linetype_manual(values = c("dotted", "solid")) +
  labs(x = "Outcome", y = "Est. Effect Size and 95% CI") +
  scale_y_continuous(limits=c(-1.5, 2),
                     n.breaks=7)+
  guides(shape=F) +
  theme_classic()+
  theme(text = element_text(size=15),
        legend.position="none") +
  coord_flip()

pdf(file="svy_coefplot.pdf",bg="transparent", width=10, height=7)
svy_coefplot
dev.off()
  
```
```{r, eval=F}
# example of coefplot for USAID
res <- res[res$Data %in% "Survey",]
res$varF <- c("Political Participation", "Political Discussions",
              "Gender Equity Index", "Feelings of Empowerment",
              "Social Norms")
res[res$varF %in% "Political Discussions" | res$varF %in% "Social Norms",c("coef_sd", "ll_sd", "ul_sd")] <- res[res$varF %in% "Political Discussions" | res$varF %in% "Social Norms",c("coef_sd", "ll_sd", "ul_sd")] *-1

res[res$varF %in% "Political Participation","ll_sd"] <- res[res$varF %in% "Political Participation","ll_sd"]+0.05
res[res$varF %in% "Political Participation","ul_sd"] <- res[res$varF %in% "Political Participation","ul_sd"]-0.05

res[res$varF %in% "Political Discussions","ll_sd"] <- res[res$varF %in% "Political Discussions","ll_sd"]-0.04
#res[res$varF %in% "Political Discussions","ul_sd"] <- res[res$varF %in% "Political Discussions","ul_sd"]
res[res$varF %in% "Social Norms","ul_sd"] <- res[res$varF %in% "Social Norms","ul_sd"]-0.05
res[res$varF %in% "Political Participation","coef_sd"] <- res[res$varF %in% "Political Participation","coef_sd"]+0.03
res[res$varF %in% "Gender Equity Index","coef_sd"] <- res[res$varF %in% "Gender Equity Index","coef_sd"]-0.03

res$varF <- factor(res$varF, 
                   levels=
                     rev(c("Political Participation",
                           "Gender Equity Index", 
                           "Feelings of Empowerment",
                           "Social Norms",
                           "Political Discussions")))


ggplot(data = res, aes(x = varF, y = coef_sd)) +
  geom_point()+
  geom_errorbar(aes(ymin = ll_sd, ymax = ul_sd), width = 0) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray")+
  labs(y = "Effect Size & 95% CI", x = NULL)+
  theme_bw() +
  #theme(axis.text = element_text(size = 12))+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggsave("coef_example.png")

```

3. Individual-level survey outcomes

Survey Outcomes: 
  - voluntary intergroup contact
  - feelings of physical security
  - intergroup attitudes

Need two point estimates & CI per outcome.

```{r}
outcome_ind <- ind.coefs
outcome_ind <- outcome_ind[grepl("Trust|contact|in_cw", outcome_ind$var),]
outcome_ind <- outcome_ind[,c(1,grep("^size.*(non|part)", names(outcome_ind)))]
outcome_ind$var <- c("Self-reported Attitudes", "Self-reported Contact", 
                 "Perceptions of Insecurity")
part <- outcome_ind[,c(1,grep("part", names(outcome_ind)))]
non <- outcome_ind[,c(1,grep("non", names(outcome_ind)))]
names(part) <- gsub("_part", "", names(part))
names(non) <- gsub("_non", "", names(non))
part$Group <- "Part"; non$Group <- "Non"
outcome_ind <- rbind(part,non)
outcome_ind$var <- 
  factor(outcome_ind$var, 
         levels = c("Self-reported Attitudes",
                    "Perceptions of Insecurity",
                    "Self-reported Contact"))
outcome_ind$Group <- factor(outcome_ind$Group, levels=
                            c("Non", "Part"))

ggplot(data = outcome_ind, aes(x = var, y = size, color = Group)) +
  geom_point(position = position_dodge(width = .3)) +
  geom_errorbar(aes(ymin = size_ll, ymax = size_ul, color = Group), width = 0, position = position_dodge(width = .3)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray")+
  labs(y = "Effect Size & 95% CI", x = NULL)+
  theme_bw() +
  #theme(axis.text = element_text(size = 12))+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  guides(color=guide_legend(reverse = TRUE))+
  scale_color_manual(values = c("Part" = "#F8766D",
                               "Non" = "#00BFC4"), name = "Group")

ggsave("coef_ind.png", width = 5, height = 3)
```

svyInd_coefplot <- ggplot(outcome_ind, aes(y=size, x = var)) +
  geom_hline(aes(yintercept = 0), linetype="dashed", color="gray")+
  geom_point(aes(shape=outcome_type, size=4)) +
  scale_shape_manual(values=c("atts"=19, "con"=17, "in"=18))+
  geom_errorbar(aes(ymin=size_ll, ymax=size_ul, width=0, linetype=dat)) +
  #scale_linetype_manual(values = c("dotted", "solid")) +
  labs(x = "Outcome", y = "Est. Effect Size and 95% CI") +
  scale_y_continuous(limits=c(-0.75, 1.5),
                     n.breaks=5)+
  guides(shape=F) +
  theme_bw()+
  theme(text = element_text(size=15),
        legend.position="none") +
  coord_flip()

pdf(file="svyInd_coefplot.pdf",bg="transparent", width=10, height=7)
svyInd_coefplot
dev.off()

png(file="svyInd_coefplot.png",bg="transparent")
svyInd_coefplot
dev.off()
```


